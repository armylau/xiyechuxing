<!-- pages/my/my.wxml - ä¸ªäººä¸­å¿ƒé¡µ -->
<view class="page">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <view class="header-content">
      <text class="header-title">ğŸ‘¤ æˆ‘çš„</text>
      <text class="header-subtitle">è®¢å• Â· ç§¯åˆ† Â· å®‰å…¨å‡ºè¡Œ</text>
    </view>
  </view>

  <!-- Tab åˆ‡æ¢ -->
  <view class="tab-bar">
    <view 
      class="tab-item {{activeTab === 'orders' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="orders"
    >ğŸ“‹ è®¢å•</view>
    <view 
      class="tab-item {{activeTab === 'points' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="points"
    >â­ ç§¯åˆ†</view>
    <view 
      class="tab-item {{activeTab === 'safety' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="safety"
    >ğŸ›¡ï¸ å®‰å…¨</view>
  </view>

  <!-- ========== è®¢å•å†…å®¹ ========== -->
  <view class="tab-content" wx:if="{{activeTab === 'orders'}}">
    <!-- æŸ¥è¯¢æ  -->
    <view class="search-bar">
      <input 
        class="search-input" 
        type="number"
        maxlength="11"
        placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢è®¢å•"
        value="{{phone}}"
        bindinput="onPhoneInput"
      />
      <button class="btn btn-primary btn-sm" bindtap="loadOrders">æŸ¥è¯¢</button>
    </view>

    <!-- æ¼”ç¤ºæ•°æ®æç¤º -->
    <view class="demo-tip" wx:if="{{useDemoOrders}}">
      <text class="demo-icon">ğŸ’¡</text>
      <text class="demo-text">å½“å‰æ˜¾ç¤ºæ¼”ç¤ºè®¢å•ï¼Œè¾“å…¥æ‰‹æœºå·å¯æŸ¥è¯¢æ‚¨çš„çœŸå®è®¢å•</text>
    </view>

    <!-- è®¢å•åˆ—è¡¨ -->
    <view class="order-list">
      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{orders.length === 0}}">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-text">{{phone ? 'æš‚æ— è¯¥æ‰‹æœºå·çš„è®¢å•' : 'æš‚æ— è®¢å•è®°å½•'}}</text>
      </view>

      <!-- è®¢å•å¡ç‰‡ -->
      <view class="order-card" wx:for="{{orders}}" wx:key="order_id">
        <view class="order-header">
          <text class="order-id">è®¢å•å·: {{item.order_id}}</text>
          <text class="order-status">{{item.status}}</text>
        </view>
        <view class="order-body">
          <view class="order-route">
            <text class="city">{{item.train.from_city}}</text>
            <text class="arrow">â†’</text>
            <text class="city">{{item.train.to_city}}</text>
          </view>
          <view class="order-detail">
            <view class="detail-item">è½¦æ¬¡: <text class="value">{{item.train.train_no}}</text></view>
            <view class="detail-item">æ—¥æœŸ: <text class="value">{{item.train.date}}</text></view>
            <view class="detail-item">ä¹˜å®¢: <text class="value">{{item.passenger_name}}</text></view>
            <view class="detail-item">æ•°é‡: <text class="value">{{item.quantity}}å¼ </text></view>
            <view class="detail-item">å‡ºå‘: <text class="value">{{item.departTime}}</text></view>
            <view class="detail-item">åˆ°è¾¾: <text class="value">{{item.arriveTime}}</text></view>
            <view class="detail-item">èˆ±ä½: <text class="value">{{item.seatClassDisplay}}</text></view>
            <view class="detail-item">é¤é£Ÿ: <text class="value">{{item.mealDisplay}}</text></view>
          </view>
        </view>
        <view class="order-footer">
          <text class="extras">
            <block wx:if="{{item.points_earned}}">ğŸ +{{item.points_earned}}ç§¯åˆ†</block>
            <block wx:if="{{item.meal && item.meal.id !== 'none'}}"> Â· å«é¤é£Ÿ Â¥{{item.meal_total}}</block>
          </text>
          <text class="total">åˆè®¡ <text class="total-num">Â¥{{item.total_price}}</text></text>
        </view>
      </view>
    </view>
  </view>

  <!-- ========== ç§¯åˆ†å†…å®¹ ========== -->
  <view class="tab-content" wx:if="{{activeTab === 'points'}}">
    <!-- æŸ¥è¯¢æ  -->
    <view class="search-bar">
      <input 
        class="search-input" 
        type="number"
        maxlength="11"
        placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢ç§¯åˆ†"
        value="{{pointsPhone}}"
        bindinput="onPointsPhoneInput"
      />
      <button class="btn btn-primary btn-sm" bindtap="loadPoints">æŸ¥è¯¢</button>
    </view>

    <!-- ç§¯åˆ†å±•ç¤º -->
    <view wx:if="{{pointsInfo}}">
      <!-- ç§¯åˆ†å¡ç‰‡ -->
      <view class="points-card">
        <view class="points-header">
          <text class="level">{{pointsInfo.level_icon || 'ğŸ«'}} {{pointsInfo.level || 'æ™®é€šä¼šå‘˜'}}</text>
          <text wx:if="{{pointsInfo.discount}}" class="discount-badge">äº«{{Math.round(pointsInfo.discount * 100)}}%æŠ˜æ‰£</text>
        </view>
        <text class="points-value">{{pointsInfo.points || 0}}</text>
        <text class="points-label">å½“å‰å¯ç”¨ç§¯åˆ† Â· ç´¯è®¡è·å¾— {{pointsInfo.total_earned || 0}}</text>
      </view>

      <!-- ç­‰çº§è§„åˆ™ -->
      <view class="section-title">ğŸ“Š ç­‰çº§è§„åˆ™</view>
      <view class="level-list">
        <view class="level-item {{pointsInfo.level === item.level ? 'active' : ''}}" wx:for="{{levels}}" wx:key="level">
          <text class="level-icon">{{item.icon}}</text>
          <view class="level-info">
            <text class="level-name">{{item.level}}</text>
            <text class="level-threshold">â‰¥ {{item.threshold}} ç§¯åˆ†</text>
          </view>
          <text class="level-discount">{{item.discount > 0 ? item.discount_label : 'â€”'}}</text>
        </view>
      </view>

      <!-- ç§¯åˆ†æ˜ç»† -->
      <view wx:if="{{pointsInfo.history && pointsInfo.history.length}}">
        <view class="section-title">ğŸ“œ ç§¯åˆ†æ˜ç»†</view>
        <view class="history-list">
          <view class="history-item" wx:for="{{pointsInfo.history}}" wx:key="time">
            <view class="history-info">
              <text class="history-reason">{{item.reason}}</text>
              <text class="history-time">{{item.time}}</text>
            </view>
            <text class="history-points">+{{item.earned}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æœªæŸ¥è¯¢çŠ¶æ€ -->
    <view class="empty-state" wx:else>
      <text class="empty-icon">â­</text>
      <text class="empty-text">è¯·è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢ç§¯åˆ†</text>
    </view>
  </view>

  <!-- ========== å®‰å…¨å†…å®¹ ========== -->
  <view class="tab-content" wx:if="{{activeTab === 'safety'}}">
    <!-- é¡¶éƒ¨æç¤º -->
    <view class="safety-banner">
      <view class="safety-title">ğŸ›¡ï¸ å®‰å…¨å‡ºè¡Œï¼Œå¹³å®‰åˆ°è¾¾</view>
      <view class="safety-subtitle">è¯·ä»”ç»†é˜…è¯»ä»¥ä¸‹å‡ºè¡Œå®‰å…¨é¡»çŸ¥ï¼Œç¡®ä¿æ—…é€”é¡ºåˆ©æ„‰å¿«</view>
    </view>

    <!-- å®‰å…¨æç¤ºåˆ—è¡¨ -->
    <view class="safety-list">
      <view class="safety-item" wx:for="{{safetyTips}}" wx:key="title">
        <text class="safety-icon">{{item.icon}}</text>
        <view class="safety-content">
          <text class="safety-item-title">{{item.title}}</text>
          <text class="safety-text">{{item.content}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
